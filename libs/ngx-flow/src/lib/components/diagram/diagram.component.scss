/* Theme Variables */
:host {
  --ngx-flow-primary: #3b82f6; /* Modern Blue */
  --ngx-flow-primary-hover: #2563eb;
  --ngx-flow-bg: #f8fafc; /* Slate 50 */
  --ngx-flow-surface: #ffffff;
  --ngx-flow-border: #e2e8f0; /* Slate 200 */
  --ngx-flow-text-primary: #1e293b; /* Slate 800 */
  --ngx-flow-text-secondary: #64748b; /* Slate 500 */
  --ngx-flow-shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
  --ngx-flow-shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
  --ngx-flow-shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
  --ngx-flow-glass-bg: rgba(255, 255, 255, 0.8);
  --ngx-flow-glass-border: rgba(255, 255, 255, 0.5);
  --ngx-flow-glass-blur: blur(12px);
  
  display: block;
  width: 100%;
  height: 100%;
  font-family: 'Inter', system-ui, -apple-system, sans-serif;
}

.ngx-flow__container {
  position: relative;
  width: 100%;
  height: 100%;
  overflow: hidden;
  background-color: var(--ngx-flow-bg);
}

.ngx-flow__diagram {
  width: 100%;
  height: 100%;
  cursor: grab;
  position: relative;
  z-index: 1;
  
  &:active {
    cursor: grabbing;
  }
}

.ngx-flow__background {
  fill: url(#ngx-flow__grid-pattern);
  opacity: 0.6;
}

.ngx-flow__viewport {
  transform-origin: 0 0;
}

/* --- Nodes --- */
.ngx-flow__node {
  cursor: grab;
  transition: transform 0.1s ease, opacity 0.2s ease;

  /* Node Body */
  .ngx-flow__node-rect {
    fill: var(--ngx-flow-surface);
    stroke: var(--ngx-flow-border);
    stroke-width: 1.5px;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.05));
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: all;
  }

  .ngx-flow__node-label {
    font-size: 12px;
    font-weight: 500;
    fill: var(--ngx-flow-text-primary);
    pointer-events: none;
    user-select: none;
  }

  /* Hover State */
  &:hover .ngx-flow__node-rect {
    stroke: var(--ngx-flow-primary);
    filter: drop-shadow(0 4px 6px rgba(0,0,0,0.08));
    transform: translateY(-1px);
  }

  /* Selected State */
  &.selected .ngx-flow__node-rect {
    stroke: var(--ngx-flow-primary);
    stroke-width: 2px;
    filter: drop-shadow(0 0 0 2px rgba(59, 130, 246, 0.2));
  }

  /* Dragging State */
  &.dragging {
    cursor: grabbing;
    opacity: 0.9;
    .ngx-flow__node-rect {
      filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1));
      transform: scale(1.02);
    }
  }

  &.dimmed {
    opacity: 0.4;
  }
}

/* Node Content (ForeignObject) */
foreignObject {
  overflow: visible;
  pointer-events: none; /* Let clicks pass to rect */
  
  /* Reset pointer events for interactive elements inside */
  * {
    pointer-events: auto;
  }
}

/* --- Edges --- */
.ngx-flow__edge {
  pointer-events: none;

  &-path {
    fill: none;
    stroke: #94a3b8; /* Slate 400 */
    stroke-width: 2;
    transition: stroke 0.2s ease, stroke-width 0.2s ease;
    pointer-events: stroke;
    cursor: pointer;
  }

  &-hitbox {
    fill: none;
    stroke: transparent;
    stroke-width: 20;
    pointer-events: stroke;
    cursor: pointer;
  }

  /* Hover State */
  &:hover .ngx-flow__edge-path {
    stroke: var(--ngx-flow-primary);
  }

  /* Selected State */
  &.selected .ngx-flow__edge-path {
    stroke: var(--ngx-flow-primary);
    stroke-width: 3;
    filter: drop-shadow(0 1px 2px rgba(59, 130, 246, 0.3));
  }

  &.animated .ngx-flow__edge-path {
    stroke-dasharray: 10;
    animation: flowAnimation 1s linear infinite;
  }
}

@keyframes flowAnimation {
  from { stroke-dashoffset: 20; }
  to { stroke-dashoffset: 0; }
}

/* --- Edge Labels --- */
.ngx-flow__edge-label {
  pointer-events: none;
  
  &-text {
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    font-weight: 500;
    fill: var(--ngx-flow-text-secondary);
    text-anchor: middle;
    dominant-baseline: middle;
  }

  &-bg {
    fill: var(--ngx-flow-surface);
    rx: 4;
    ry: 4;
    filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
  }
  
  &-input {
    width: 100%;
    height: 100%;
    border: 1px solid var(--ngx-flow-primary);
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 12px;
    text-align: center;
    background: var(--ngx-flow-surface);
    pointer-events: all;
    outline: none;
    box-shadow: var(--ngx-flow-shadow-sm);
  }
}

/* --- Handles --- */
/* --- Handles --- */
.ngx-flow__handle {
  opacity: 1; /* Always visible */
  transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
  pointer-events: all;

  &-circle {
    fill: var(--ngx-flow-surface);
    stroke: var(--ngx-flow-text-secondary);
    stroke-width: 1.5;
    transition: all 0.2s ease;
    
    &:hover {
      fill: var(--ngx-flow-primary);
      stroke: var(--ngx-flow-primary);
      r: 7; /* Scale up slightly */
    }
  }

  &.ngx-flow__handle--valid-target .ngx-flow__handle-circle {
    fill: #10b981 !important; /* Emerald 500 */
    stroke: #059669 !important;
    r: 8;
    stroke-width: 2;
  }
}

/* --- Controls (Glassmorphism) --- */
.ngx-flow__io-controls {
  position: absolute;
  top: 16px;
  left: 16px;
  z-index: 10;
  display: flex;
  gap: 8px;
  padding: 8px;
  
  /* Glassmorphism */
  background: var(--ngx-flow-glass-bg);
  backdrop-filter: var(--ngx-flow-glass-blur);
  border: 1px solid var(--ngx-flow-glass-border);
  border-radius: 12px;
  box-shadow: var(--ngx-flow-shadow-md);
  
  align-items: center;

  input[type="text"] {
    padding: 6px 12px;
    border: 1px solid transparent;
    border-radius: 8px;
    font-size: 13px;
    background: rgba(0,0,0,0.05);
    transition: all 0.2s ease;
    width: 160px;
    
    &:focus {
      background: white;
      border-color: var(--ngx-flow-primary);
      outline: none;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }
  }

  select {
    padding: 6px 12px;
    border: 1px solid transparent;
    border-radius: 8px;
    font-size: 13px;
    background: rgba(0,0,0,0.05);
    cursor: pointer;
    transition: all 0.2s ease;
    
    &:hover {
      background: rgba(0,0,0,0.08);
    }
    
    &:focus {
      outline: none;
      border-color: var(--ngx-flow-primary);
    }
  }

  .ngx-flow__separator {
    width: 1px;
    height: 24px;
    background: rgba(0,0,0,0.1);
    margin: 0 4px;
  }

  button {
    padding: 6px 12px;
    background: transparent;
    border: 1px solid transparent;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    color: var(--ngx-flow-text-primary);
    transition: all 0.2s ease;

    &:hover {
      background: rgba(0,0,0,0.05);
      color: var(--ngx-flow-primary);
    }
    
    &:active {
      transform: translateY(1px);
    }
  }
}

/* --- Group Nodes --- */
.ngx-flow__group-node {
  .ngx-flow__group-header {
    fill: rgba(0,0,0,0.03);
    stroke: none;
  }
  
  .ngx-flow__group-label {
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    font-weight: 600;
    fill: var(--ngx-flow-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .ngx-flow__group-toggle {
    cursor: pointer;
    opacity: 0.6;
    transition: opacity 0.2s;
    
    &:hover {
      opacity: 1;
    }
    
    &-bg {
      fill: rgba(0,0,0,0.1);
    }
    
    &-icon {
      stroke: var(--ngx-flow-text-secondary);
      stroke-width: 1.5;
      fill: none;
    }
  }
}

/* --- Alignment Guides --- */
.ngx-flow__alignment-guide {
  pointer-events: none;
  line {
    stroke: #ec4899; /* Pink 500 */
    stroke-width: 1;
    stroke-dasharray: 4 4;
    opacity: 0.8;
  }
}

/* --- Resize Handles --- */
.ngx-flow__resize-handle {
  fill: var(--ngx-flow-surface);
  stroke: var(--ngx-flow-primary);
  stroke-width: 1.5;
  width: 8px;
  height: 8px;
  transition: transform 0.2s ease;
  
  /* Ensure scaling happens from center to avoid moving the element away from mouse */
  transform-box: fill-box;
  transform-origin: center;

  &:hover {
    fill: var(--ngx-flow-primary);
    transform: scale(1.2);
  }

  &[data-handle='nw'] {
    cursor: nw-resize;
  }

  &[data-handle='ne'] {
    cursor: ne-resize;
  }

  &[data-handle='sw'] {
    cursor: sw-resize;
  }

  &[data-handle='se'] {
    cursor: se-resize;
  }
}
